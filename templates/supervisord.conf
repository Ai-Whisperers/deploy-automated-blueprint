; Supervisord Configuration Template
; Level 2 Orchestration - Multiple services on single machine
; Place at: /etc/supervisor/conf.d/app.conf
;
; Install: apt install supervisor
; Reload: supervisorctl reread && supervisorctl update
; Status: supervisorctl status

[supervisord]
nodaemon=false
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

; ===========================================
; Frontend Service
; ===========================================
[program:frontend]
command=node /app/web/dist/index.js
directory=/app/web
user=app
autostart=true
autorestart=true
startsecs=5
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/frontend.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
environment=NODE_ENV="production",PORT="%(ENV_PORT_FRONTEND)s"

; ===========================================
; API Service
; ===========================================
[program:api]
command=/app/api/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port %(ENV_PORT_API)s
directory=/app/api
user=app
autostart=true
autorestart=true
startsecs=5
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/api.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
environment=APP_ENV="production"

; ===========================================
; Background Worker (uncomment if needed)
; ===========================================
; [program:worker]
; command=/app/api/venv/bin/celery -A app.tasks worker --loglevel=info
; directory=/app/api
; user=app
; autostart=true
; autorestart=true
; startsecs=10
; startretries=3
; redirect_stderr=true
; stdout_logfile=/var/log/supervisor/worker.log
; stdout_logfile_maxbytes=10MB
; stdout_logfile_backups=5
; environment=APP_ENV="production"

; ===========================================
; Cloudflare Tunnel
; ===========================================
[program:cloudflared]
command=cloudflared tunnel run %(ENV_TUNNEL_NAME)s
directory=/app
user=app
autostart=true
autorestart=true
startsecs=5
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/cloudflared.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5

; ===========================================
; Group Configuration
; ===========================================
[group:app]
programs=frontend,api,cloudflared
priority=999

; ===========================================
; Supervisorctl Socket
; ===========================================
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
